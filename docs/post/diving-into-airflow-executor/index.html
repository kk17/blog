<!DOCTYPE html>
<html lang="en" itemscope itemtype="http://schema.org/WebPage">
<head>
  <meta charset="utf-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <title>Diving Into Airflow Executor - Code Play</title>
  

<meta name="renderer" content="webkit" />
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1"/>

<meta name="MobileOptimized" content="width"/>
<meta name="HandheldFriendly" content="true"/>


<meta name="applicable-device" content="pc,mobile">

<meta name="theme-color" content="#f8f5ec" />
<meta name="msapplication-navbutton-color" content="#f8f5ec">
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="#f8f5ec">

<meta name="mobile-web-app-capable" content="yes">

<meta name="author" content="Kyle" /><meta name="description" content="airflow scheduler" />
<meta name="keywords" content="airflow" />







<meta name="generator" content="Hugo 0.55.4" />


<link rel="canonical" href="https://blog.kk17.net/post/diving-into-airflow-executor/" />



<link rel="icon" href="/favicon.ico" />











<link rel="stylesheet" href="/sass/jane.min.ec807d8b802a40889537c26e014f733206312ea440d42e1f0dabed80918de1ac.css" integrity="sha256-7IB9i4AqQIiVN8JuAU9zMgYxLqRA1C4fDavtgJGN4aw=" media="screen" crossorigin="anonymous">





<meta property="og:title" content="Diving Into Airflow Executor" />
<meta property="og:description" content="airflow scheduler" />
<meta property="og:type" content="article" />
<meta property="og:url" content="https://blog.kk17.net/post/diving-into-airflow-executor/" />
<meta property="article:published_time" content="2019-07-26T10:02:55&#43;08:00"/>
<meta property="article:modified_time" content="2019-07-26T10:02:55&#43;08:00"/>

<meta itemprop="name" content="Diving Into Airflow Executor">
<meta itemprop="description" content="airflow scheduler">


<meta itemprop="datePublished" content="2019-07-26T10:02:55&#43;08:00" />
<meta itemprop="dateModified" content="2019-07-26T10:02:55&#43;08:00" />
<meta itemprop="wordCount" content="2327">



<meta itemprop="keywords" content="airflow," />
<meta name="twitter:card" content="summary"/>
<meta name="twitter:title" content="Diving Into Airflow Executor"/>
<meta name="twitter:description" content="airflow scheduler"/>

<!--[if lte IE 9]>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/classlist/1.1.20170427/classList.min.js"></script>
<![endif]-->

<!--[if lt IE 9]>
  <script src="https://cdn.jsdelivr.net/npm/html5shiv@3.7.3/dist/html5shiv.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/respond.js@1.4.2/dest/respond.min.js"></script>
<![endif]-->


<script type="application/javascript">
var doNotTrack = false;
if (!doNotTrack) {
	window.ga=window.ga||function(){(ga.q=ga.q||[]).push(arguments)};ga.l=+new Date;
	ga('create', 'UA-140906699-1', 'auto');
	
	ga('send', 'pageview');
}
</script>
<script async src='https://www.google-analytics.com/analytics.js'></script>



</head>
<body>
  <div id="mobile-navbar" class="mobile-navbar">
  <div class="mobile-header-logo">
    <a href="/" class="logo">Code Play</a>
  </div>
  <div class="mobile-navbar-icon">
    <span></span>
    <span></span>
    <span></span>
  </div>
</div>
<nav id="mobile-menu" class="mobile-menu slideout-menu">
  <ul class="mobile-menu-list">
    <li class="mobile-menu-item">
        
          
          
            <a class="menu-item-link" href="https://blog.kk17.net/">Home</a>
          
        
      </li><li class="mobile-menu-item">
        
          
          
            <a class="menu-item-link" href="https://blog.kk17.net/post/">Archives</a>
          
        
      </li><li class="mobile-menu-item">
        
          
          
            <a class="menu-item-link" href="https://blog.kk17.net/tags/">Tags</a>
          
        
      </li><li class="mobile-menu-item">
        
          
          
            <a class="menu-item-link" href="https://blog.kk17.net/categories/">Categories</a>
          
        
      </li><li class="mobile-menu-item">
        
          
          
            <a class="menu-item-link" href="https://kk17.net" rel="noopener" target="_blank">
              About
              
              <i class="iconfont">
                <svg class="icon" viewBox="0 0 1024 1024" version="1.1"
  xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink"
  width="18" height="18">
  <path d="M623.36 272.96 473.216 423.04C467.2 429.056 467.072 438.656 472.896 444.416c0 0-6.72-6.656 1.6 1.6C496.064 467.648 528.64 500.224 528.64 500.224 534.464 506.048 544 505.856 550.016 499.904l150.08-150.144 67.328 66.432c9.024 8.96 27.456 4.544 30.4-8.96 19.968-92.608 46.656-227.52 46.656-227.52 6.848-34.496-16.192-56.704-49.92-49.92 0 0-134.656 26.816-227.328 46.784C560.32 178.048 556.352 182.272 554.752 187.136c-3.2 6.208-3.008 14.208 3.776 20.992L623.36 272.96z"></path>
  <path d="M841.152 457.152c-30.528 0-54.784 24.512-54.784 54.656l0 274.752L237.696 786.56 237.696 237.696l206.016 0c6.656 0 10.752 0 13.248 0C487.68 237.696 512 213.184 512 182.848 512 152.32 487.36 128 456.96 128L183.04 128C153.216 128 128 152.576 128 182.848c0 3.136 0.256 6.272 0.768 9.28C128.256 195.136 128 198.272 128 201.408l0 639.488c0 0.064 0 0.192 0 0.256 0 0.128 0 0.192 0 0.32 0 30.528 24.512 54.784 54.784 54.784l646.976 0c6.592 0 9.728 0 11.712 0 28.736 0 52.928-22.976 54.464-51.968C896 843.264 896 842.304 896 841.344l0-20.352L896 561.408 896 512.128C896 481.792 871.424 457.152 841.152 457.152z"></path>
</svg>

              </i>
            </a>
          
        
      </li>
    
  </ul>
</nav>


  
    






  <link rel="stylesheet" href="/lib/photoswipe/photoswipe.min.css" />
  <link rel="stylesheet" href="/lib/photoswipe/default-skin/default-skin.min.css" />




<div class="pswp" tabindex="-1" role="dialog" aria-hidden="true">

<div class="pswp__bg"></div>

<div class="pswp__scroll-wrap">
    
    <div class="pswp__container">
      <div class="pswp__item"></div>
      <div class="pswp__item"></div>
      <div class="pswp__item"></div>
    </div>
    
    <div class="pswp__ui pswp__ui--hidden">
    <div class="pswp__top-bar">
      
      <div class="pswp__counter"></div>
      <button class="pswp__button pswp__button--close" title="Close (Esc)"></button>
      <button class="pswp__button pswp__button--share" title="Share"></button>
      <button class="pswp__button pswp__button--fs" title="Toggle fullscreen"></button>
      <button class="pswp__button pswp__button--zoom" title="Zoom in/out"></button>
      
      
      <div class="pswp__preloader">
        <div class="pswp__preloader__icn">
          <div class="pswp__preloader__cut">
            <div class="pswp__preloader__donut"></div>
          </div>
        </div>
      </div>
    </div>
    <div class="pswp__share-modal pswp__share-modal--hidden pswp__single-tap">
      <div class="pswp__share-tooltip"></div>
    </div>
    <button class="pswp__button pswp__button--arrow--left" title="Previous (arrow left)">
    </button>
    <button class="pswp__button pswp__button--arrow--right" title="Next (arrow right)">
    </button>
    <div class="pswp__caption">
      <div class="pswp__caption__center"></div>
    </div>
    </div>
    </div>
</div>

  

  

  <header id="header" class="header container">
    <div class="logo-wrapper">
  <a href="/" class="logo">
    
      Code Play
    
  </a>
</div>

<nav class="site-navbar">
  <ul id="menu" class="menu">
    
    
        <li class="menu-item">
        
          
          
            <a class="menu-item-link" href="https://blog.kk17.net/">Home</a>
          

        

      </li>
    
        <li class="menu-item">
        
          
          
            <a class="menu-item-link" href="https://blog.kk17.net/post/">Archives</a>
          

        

      </li>
    
        <li class="menu-item">
        
          
          
            <a class="menu-item-link" href="https://blog.kk17.net/tags/">Tags</a>
          

        

      </li>
    
        <li class="menu-item">
        
          
          
            <a class="menu-item-link" href="https://blog.kk17.net/categories/">Categories</a>
          

        

      </li>
    
        <li class="menu-item">
        
          
          
            <a class="menu-item-link" href="https://kk17.net" rel="noopener" target="_blank">
              About
              
              <i class="iconfont">
                <svg class="icon" viewBox="0 0 1024 1024" version="1.1"
  xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink"
  width="18" height="18">
  <path d="M623.36 272.96 473.216 423.04C467.2 429.056 467.072 438.656 472.896 444.416c0 0-6.72-6.656 1.6 1.6C496.064 467.648 528.64 500.224 528.64 500.224 534.464 506.048 544 505.856 550.016 499.904l150.08-150.144 67.328 66.432c9.024 8.96 27.456 4.544 30.4-8.96 19.968-92.608 46.656-227.52 46.656-227.52 6.848-34.496-16.192-56.704-49.92-49.92 0 0-134.656 26.816-227.328 46.784C560.32 178.048 556.352 182.272 554.752 187.136c-3.2 6.208-3.008 14.208 3.776 20.992L623.36 272.96z"></path>
  <path d="M841.152 457.152c-30.528 0-54.784 24.512-54.784 54.656l0 274.752L237.696 786.56 237.696 237.696l206.016 0c6.656 0 10.752 0 13.248 0C487.68 237.696 512 213.184 512 182.848 512 152.32 487.36 128 456.96 128L183.04 128C153.216 128 128 152.576 128 182.848c0 3.136 0.256 6.272 0.768 9.28C128.256 195.136 128 198.272 128 201.408l0 639.488c0 0.064 0 0.192 0 0.256 0 0.128 0 0.192 0 0.32 0 30.528 24.512 54.784 54.784 54.784l646.976 0c6.592 0 9.728 0 11.712 0 28.736 0 52.928-22.976 54.464-51.968C896 843.264 896 842.304 896 841.344l0-20.352L896 561.408 896 512.128C896 481.792 871.424 457.152 841.152 457.152z"></path>
</svg>

              </i>
            </a>
          

        

      </li>
    
    
  </ul>
</nav>

  </header>

  <div id="mobile-panel">
    <main id="main" class="main bg-llight">
      <div class="content-wrapper">
        <div id="content" class="content container">
          <article class="post bg-white">
    
    <header class="post-header">
      <h1 class="post-title">Diving Into Airflow Executor</h1>
      
      <div class="post-meta">
        <time datetime="2019-07-26" class="post-time">
          2019-07-26
        </time>
        <div class="post-category">
            <a href="https://blog.kk17.net/categories/big-data/"> big-data </a>
            
          </div>
        

        
        

        
        
      </div>
    </header>

    
    
<div class="post-toc" id="post-toc">
  <h2 class="post-toc-title">Table of Contents</h2>
  <div class="post-toc-content">
    <nav id="TableOfContents">
<ul>
<li>
<ul>
<li><a href="#key-concept">Key Concept</a></li>
<li><a href="#process-loop">Process Loop</a></li>
<li><a href="#dagfileprocessormanager-heartbeat">DagFileProcessorManager Heartbeat</a></li>
<li><a href="#schedulejob-process-file">ScheduleJob Process File</a></li>
<li><a href="#overview">Overview</a></li>
<li><a href="#reference">Reference</a></li>
</ul></li>
</ul>
</nav>
  </div>
</div>

    
    <div class="post-content">
      <p><a href="../understand-airflow">Last article</a> we told about the basic concepts and architecture of Airflow, and we knew that Airflow has three major components:  <code>webserver</code>,  <code>scheduler</code> and <code>executor.</code>  This article will talk about the detail of the <code>scheduler</code> by diving into some of the source code(version: 1.10.1).</p>

<h2 id="key-concept">Key Concept</h2>

<p>We already told about the key concepts of Airflow, let&rsquo;s recap some concepts use in airflow scheduler here.</p>

<ul>
<li>Dag Files: Python files that could contain DAGs. A DAG can be definite in a single python file or in multiple python files packaged into an egg file.</li>
<li>Dag (Directed Acyclic Graph): a workflow which glues all the tasks with inter-dependencies.</li>
<li>Task: a parameterized instance of an operator/sensor which represents a unit of actual work to be executed.</li>
<li>DagRun:  an object representing an instantiation of the DAG in time.</li>
<li>TaskInstance: an object representing an instantiation of the Task in time.</li>
<li>DagBag: a collection of dags, parsed out of a folder tree and has high
level configuration settings, like what database to use as a backend and
what executor to use to fire off tasks.</li>
<li>Job: Jobs are processing items with state
and duration that aren&rsquo;t task instances. There are three types of job in Airflow: ScheduleJob, LocalTaskJob, and BackfillJob.</li>
</ul>

<h2 id="process-loop">Process Loop</h2>

<p>The Airflow scheduler is designed to run as a persistent service in an Airflow production environment. To kick it off, all you need to do is execute <code>airflow scheduler</code> command. Let&rsquo;s look at how Airflow parses this command and start the process loop.</p>

<p><img src="/process_loop_outer/process_loop_outer.svg" alt="process_loop_outer" /></p>

<p>Firstly, airflow use <code>argparse</code> to parse the command and invoke the <code>scheduler</code> function in <code>airflow.bin.cli</code>. And then <code>scheduler</code> function creates a ScheduleJob and run its <code>run</code> method. The ScheduleJob will save itself to the database, start the executor and create a <code>DagFileProcessorManager</code>. Eventually, the ScheduleJob will run a loop to invoke the <code>processor_manager periodically .heartbeat</code> method.</p>

<p>All the daemon service of Airflow are started by running <code>airflow {serve_name}</code> command. Basically, the <code>airflow</code> command is a python command-line script. We can look at the source code to know how it starts the service.</p>

<p><a href="https://github.com/apache/airflow/blob/1.10.1/airflow/bin/airflow#L20">airflow/bin/airflow</a></p>
<div class="highlight" style="background: #f8f8f8"><pre style="line-height: 125%"><code class="language-python" data-lang="python"><span></span><span style="color: #008000; font-weight: bold">from</span> <span style="color: #0000FF; font-weight: bold">airflow.bin.cli</span> <span style="color: #008000; font-weight: bold">import</span> CLIFactory

<span style="color: #008000; font-weight: bold">if</span> <span style="color: #19177C">__name__</span> <span style="color: #666666">==</span> <span style="color: #BA2121">&#39;__main__&#39;</span>:
    parser <span style="color: #666666">=</span> CLIFactory<span style="color: #666666">.</span>get_parser()
    args <span style="color: #666666">=</span> parser<span style="color: #666666">.</span>parse_args()
    args<span style="color: #666666">.</span>func(args)
</code></pre></div>

<p><a href="https://github.com/apache/airflow/blob/1.10.1/airflow/bin/cli.py#L1247">airflow/bin/cli.py#CLIFactory</a></p>
<div class="highlight" style="background: #f8f8f8"><pre style="line-height: 125%"><code class="language-python" data-lang="python"><span></span><span style="color: #008000; font-weight: bold">class</span> <span style="color: #0000FF; font-weight: bold">CLIFactory</span>(<span style="color: #008000">object</span>):
    args <span style="color: #666666">=</span> {
        <span style="color: #BA2121">&#39;dag_id&#39;</span>: Arg((<span style="color: #BA2121">&quot;dag_id&quot;</span>,), <span style="color: #BA2121">&quot;The id of the dag&quot;</span>),
        <span style="color: #BA2121">&#39;task_id&#39;</span>: Arg((<span style="color: #BA2121">&quot;task_id&quot;</span>,), <span style="color: #BA2121">&quot;The id of the task&quot;</span>),
        <span style="color: #666666">...</span>
    },
    subparsers <span style="color: #666666">=</span> (
      <span style="color: #666666">...</span>
      {
          <span style="color: #BA2121">&#39;func&#39;</span>: scheduler,
          <span style="color: #BA2121">&#39;help&#39;</span>: <span style="color: #BA2121">&quot;Start a scheduler instance&quot;</span>,
          <span style="color: #BA2121">&#39;args&#39;</span>: (<span style="color: #BA2121">&#39;dag_id_opt&#39;</span>, <span style="color: #BA2121">&#39;subdir&#39;</span>, <span style="color: #BA2121">&#39;run_duration&#39;</span>, <span style="color: #BA2121">&#39;num_runs&#39;</span>,
                   <span style="color: #BA2121">&#39;do_pickle&#39;</span>, <span style="color: #BA2121">&#39;pid&#39;</span>, <span style="color: #BA2121">&#39;daemon&#39;</span>, <span style="color: #BA2121">&#39;stdout&#39;</span>, <span style="color: #BA2121">&#39;stderr&#39;</span>,
                   <span style="color: #BA2121">&#39;log_file&#39;</span>),
      },
      <span style="color: #666666">...</span>
    )
    subparsers_dict <span style="color: #666666">=</span> {sp[<span style="color: #BA2121">&#39;func&#39;</span>]<span style="color: #666666">.</span><span style="color: #19177C">__name__</span>: sp <span style="color: #008000; font-weight: bold">for</span> sp <span style="color: #AA22FF; font-weight: bold">in</span> subparsers}
    dag_subparsers <span style="color: #666666">=</span> (
        <span style="color: #BA2121">&#39;list_tasks&#39;</span>, <span style="color: #BA2121">&#39;backfill&#39;</span>, <span style="color: #BA2121">&#39;test&#39;</span>, <span style="color: #BA2121">&#39;run&#39;</span>, <span style="color: #BA2121">&#39;pause&#39;</span>, <span style="color: #BA2121">&#39;unpause&#39;</span>)
</code></pre></div>

<p>There are two important mappings in the <code>CLIFactory</code>, <code>args</code> maps the command line arguments to some default value and help information. <code>subparsers_dict</code> maps the subcommand to objective python function.</p>

<p><a href="https://github.com/apache/airflow/blob/1.10.1/airflow/bin/cli.py#L903">airflow/bin/cli.py#scheduler</a></p>
<div class="highlight" style="background: #f8f8f8"><pre style="line-height: 125%"><code class="language-python" data-lang="python"><span></span><span style="color: #AA22FF">@cli_utils.action_logging</span>
<span style="color: #008000; font-weight: bold">def</span> <span style="color: #0000FF">scheduler</span>(args):
    <span style="color: #008000; font-weight: bold">print</span>(settings<span style="color: #666666">.</span>HEADER)
    job <span style="color: #666666">=</span> jobs<span style="color: #666666">.</span>SchedulerJob(
        dag_id<span style="color: #666666">=</span>args<span style="color: #666666">.</span>dag_id,
        subdir<span style="color: #666666">=</span>process_subdir(args<span style="color: #666666">.</span>subdir),
        run_duration<span style="color: #666666">=</span>args<span style="color: #666666">.</span>run_duration,
        num_runs<span style="color: #666666">=</span>args<span style="color: #666666">.</span>num_runs,
        do_pickle<span style="color: #666666">=</span>args<span style="color: #666666">.</span>do_pickle)

    <span style="color: #008000; font-weight: bold">if</span> args<span style="color: #666666">.</span>daemon:
        pid, stdout, stderr, log_file <span style="color: #666666">=</span> setup_locations(<span style="color: #BA2121">&quot;scheduler&quot;</span>,
        <span style="color: #666666">...</span>
        ctx <span style="color: #666666">=</span> daemon<span style="color: #666666">.</span>DaemonContext(
        <span style="color: #666666">...</span>
        <span style="color: #008000; font-weight: bold">with</span> ctx:
            job<span style="color: #666666">.</span>run()
        <span style="color: #666666">...</span>
    <span style="color: #008000; font-weight: bold">else</span>:
        <span style="color: #666666">...</span>
        job<span style="color: #666666">.</span>run()
</code></pre></div>

<p><a href="https://github.com/apache/airflow/blob/1.10.1/airflow/jobs.py#L191">airflow/jobs.py#ScheduleJob.run</a></p>
<div class="highlight" style="background: #f8f8f8"><pre style="line-height: 125%"><code class="language-python" data-lang="python"><span></span>  <span style="color: #008000; font-weight: bold">def</span> <span style="color: #0000FF">run</span>(<span style="color: #008000">self</span>):
    Stats<span style="color: #666666">.</span>incr(<span style="color: #008000">self</span><span style="color: #666666">.</span><span style="color: #19177C">__class__</span><span style="color: #666666">.</span><span style="color: #19177C">__name__</span><span style="color: #666666">.</span>lower() <span style="color: #666666">+</span> <span style="color: #BA2121">&#39;_start&#39;</span>, <span style="color: #666666">1</span>, <span style="color: #666666">1</span>)
    <span style="color: #408080; font-style: italic"># Adding an entry in the DB</span>
    <span style="color: #008000; font-weight: bold">with</span> create_session() <span style="color: #008000; font-weight: bold">as</span> session:
        <span style="color: #008000">self</span><span style="color: #666666">.</span>state <span style="color: #666666">=</span> State<span style="color: #666666">.</span>RUNNING
        session<span style="color: #666666">.</span>add(<span style="color: #008000">self</span>)
        session<span style="color: #666666">.</span>commit()
        <span style="color: #666666">...</span>
        <span style="color: #008000; font-weight: bold">try</span>:
            <span style="color: #008000">self</span><span style="color: #666666">.</span>_execute()
            <span style="color: #408080; font-style: italic"># In case of max runs or max duration</span>
            <span style="color: #008000">self</span><span style="color: #666666">.</span>state <span style="color: #666666">=</span> State<span style="color: #666666">.</span>SUCCESS
        <span style="color: #008000; font-weight: bold">except</span> <span style="color: #D2413A; font-weight: bold">SystemExit</span> <span style="color: #008000; font-weight: bold">as</span> e:
        <span style="color: #666666">...</span>
        <span style="color: #008000; font-weight: bold">finally</span>:
            <span style="color: #008000">self</span><span style="color: #666666">.</span>end_date <span style="color: #666666">=</span> timezone<span style="color: #666666">.</span>utcnow()
            session<span style="color: #666666">.</span>merge(<span style="color: #008000">self</span>)
            session<span style="color: #666666">.</span>commit()
  <span style="color: #008000; font-weight: bold">def</span> <span style="color: #0000FF">_execute</span>(<span style="color: #008000">self</span>):
    <span style="color: #008000; font-weight: bold">raise</span> <span style="color: #D2413A; font-weight: bold">NotImplementedError</span>(<span style="color: #BA2121">&quot;This method needs to be overridden&quot;</span>)
</code></pre></div>

<p>We can know that the scheduler service is actually an <code>airflow.jobs.SchedulerJob</code> instance that runs its <code>run</code> method. It will add itself into the database <code>job</code> table and then run the <code>_execute</code> helper method handling some and normal exit situations. Now let us look at the <code>_execute</code> method.</p>

<p><a href="https://github.com/apache/airflow/blob/1.10.1/airflow/jobs.py#L1544">airflow/jobs.py#ScheduleJob._execute</a></p>
<div class="highlight" style="background: #f8f8f8"><pre style="line-height: 125%"><code class="language-python" data-lang="python"><span></span><span style="color: #008000; font-weight: bold">def</span> <span style="color: #0000FF">_execute</span>(<span style="color: #008000">self</span>):
    <span style="color: #408080; font-style: italic"># Use multiple processes to parse and generate tasks for the</span>
    <span style="color: #408080; font-style: italic"># DAGs in parallel. By processing them in separate processes,</span>
    <span style="color: #408080; font-style: italic"># we can get parallelism and isolation from potentially harmful</span>
    <span style="color: #408080; font-style: italic"># user code.</span>

    <span style="color: #408080; font-style: italic"># Build up a list of Python files that could contain DAGs</span>
    known_file_paths <span style="color: #666666">=</span> list_py_file_paths(<span style="color: #008000">self</span><span style="color: #666666">.</span>subdir)

    processor_manager <span style="color: #666666">=</span> DagFileProcessorManager(<span style="color: #008000">self</span><span style="color: #666666">.</span>subdir,
                                                known_file_paths,
                                                <span style="color: #008000">self</span><span style="color: #666666">.</span>max_threads,
                                                <span style="color: #008000">self</span><span style="color: #666666">.</span>file_process_interval,
                                                <span style="color: #008000">self</span><span style="color: #666666">.</span>file_process_interval,
                                                processor_factory)

    <span style="color: #008000; font-weight: bold">try</span>:
        <span style="color: #008000">self</span><span style="color: #666666">.</span>_execute_helper(processor_manager)
    <span style="color: #008000; font-weight: bold">finally</span>:
        <span style="color: #008000">self</span><span style="color: #666666">.</span>log<span style="color: #666666">.</span>info(<span style="color: #BA2121">&quot;Exited execute loop&quot;</span>)

        <span style="color: #408080; font-style: italic"># Kill all child processes on exit since we don&#39;t want to leave</span>
        <span style="color: #408080; font-style: italic"># them as orphaned.</span>
        pids_to_kill <span style="color: #666666">=</span> processor_manager<span style="color: #666666">.</span>get_all_pids()
        <span style="color: #666666">...</span>
</code></pre></div>

<p>We can see that <code>_execute</code> method create a <code>processor_manager</code> and the <code>processor_manager</code> use <code>processor_factory</code> to create a processor for each dag file_path. We can also find out it uses configurations which configured in the <code>airflow.cfg</code> file.</p>
<div class="highlight" style="background: #f8f8f8"><pre style="line-height: 125%"><code class="language-python" data-lang="python"><span></span>file_process_interval<span style="color: #666666">=</span>conf<span style="color: #666666">.</span>getint(<span style="color: #BA2121">&#39;scheduler&#39;</span>, <span style="color: #BA2121">&#39;min_file_process_interval&#39;</span>),
<span style="color: #008000">self</span><span style="color: #666666">.</span>heartrate <span style="color: #666666">=</span> conf<span style="color: #666666">.</span>getint(<span style="color: #BA2121">&#39;scheduler&#39;</span>, <span style="color: #BA2121">&#39;SCHEDULER_HEARTBEAT_SEC&#39;</span>)
<span style="color: #008000">self</span><span style="color: #666666">.</span>max_threads <span style="color: #666666">=</span> conf<span style="color: #666666">.</span>getint(<span style="color: #BA2121">&#39;scheduler&#39;</span>, <span style="color: #BA2121">&#39;max_threads&#39;</span>)

<span style="color: #408080; font-style: italic"># How often to scan the DAGs directory for new files. Default to 5 minutes.</span>
<span style="color: #008000">self</span><span style="color: #666666">.</span>dag_dir_list_interval <span style="color: #666666">=</span> conf<span style="color: #666666">.</span>getint(<span style="color: #BA2121">&#39;scheduler&#39;</span>, <span style="color: #BA2121">&#39;dag_dir_list_interval&#39;</span>)
<span style="color: #408080; font-style: italic"># How often to print out DAG file processing stats to the log. Default to</span>
<span style="color: #408080; font-style: italic"># 30 seconds.</span>
<span style="color: #008000">self</span><span style="color: #666666">.</span>print_stats_interval <span style="color: #666666">=</span> conf<span style="color: #666666">.</span>getint(<span style="color: #BA2121">&#39;scheduler&#39;</span>, <span style="color: #BA2121">&#39;print_stats_interval&#39;</span>)
<span style="color: #408080; font-style: italic"># Parse and schedule each file no faster than this interval. Default</span>
<span style="color: #408080; font-style: italic"># to 3 minutes.</span>
<span style="color: #008000">self</span><span style="color: #666666">.</span>file_process_interval <span style="color: #666666">=</span> file_process_interval

<span style="color: #008000">self</span><span style="color: #666666">.</span>max_tis_per_query <span style="color: #666666">=</span> conf<span style="color: #666666">.</span>getint(<span style="color: #BA2121">&#39;scheduler&#39;</span>, <span style="color: #BA2121">&#39;max_tis_per_query&#39;</span>)
<span style="color: #008000; font-weight: bold">if</span> run_duration <span style="color: #AA22FF; font-weight: bold">is</span> <span style="color: #008000">None</span>:
    <span style="color: #008000">self</span><span style="color: #666666">.</span>run_duration <span style="color: #666666">=</span> conf<span style="color: #666666">.</span>getint(<span style="color: #BA2121">&#39;scheduler&#39;</span>, <span style="color: #BA2121">&#39;run_duration&#39;</span>)
</code></pre></div>

<p>Then the <code>_execute</code> method run the <code>_execute_helper</code> method.</p>

<p><a href="https://github.com/apache/airflow/blob/1.10.1/a.irflow/jobs.py#L1627">airflow/jobs.py#ScheduleJob._execute_helper</a></p>
<div class="highlight" style="background: #f8f8f8"><pre style="line-height: 125%"><code class="language-python" data-lang="python"><span></span><span style="color: #008000; font-weight: bold">def</span> <span style="color: #0000FF">_execute_helper</span>(<span style="color: #008000">self</span>, processor_manager):
    <span style="color: #008000">self</span><span style="color: #666666">.</span>executor<span style="color: #666666">.</span>start()

    <span style="color: #408080; font-style: italic">## self.log.info(&quot;Resetting orphaned tasks for active dag runs&quot;)</span>
    <span style="color: #008000">self</span><span style="color: #666666">.</span>reset_state_for_orphaned_tasks()

    execute_start_time <span style="color: #666666">=</span> timezone<span style="color: #666666">.</span>utcnow()

    <span style="color: #408080; font-style: italic"># Use this value initially</span>
    known_file_paths <span style="color: #666666">=</span> processor_manager<span style="color: #666666">.</span>file_paths


    <span style="color: #408080; font-style: italic"># For the execute duration, parse and schedule DAGs</span>
    <span style="color: #008000; font-weight: bold">while</span> (timezone<span style="color: #666666">.</span>utcnow() <span style="color: #666666">-</span> execute_start_time)<span style="color: #666666">.</span>total_seconds() <span style="color: #666666">&lt;</span>    <span style="color: #008000">self</span><span style="color: #666666">.</span>run_duration <span style="color: #AA22FF; font-weight: bold">or</span> <span style="color: #008000">self</span><span style="color: #666666">.</span>run_duration <span style="color: #666666">&lt;</span> <span style="color: #666666">0</span>:
        <span style="color: #008000">self</span><span style="color: #666666">.</span>log<span style="color: #666666">.</span>debug(<span style="color: #BA2121">&quot;Starting Loop...&quot;</span>)

        <span style="color: #008000; font-weight: bold">if</span> elapsed_time_since_refresh <span style="color: #666666">&gt;</span> <span style="color: #008000">self</span><span style="color: #666666">.</span>dag_dir_list_interval:
                    <span style="color: #408080; font-style: italic"># Build up a list of Python files that could contain DAGs</span>
                    known_file_paths <span style="color: #666666">=</span> list_py_file_paths(<span style="color: #008000">self</span><span style="color: #666666">.</span>subdir)
                    last_dag_dir_refresh_time <span style="color: #666666">=</span> timezone<span style="color: #666666">.</span>utcnow()
                    processor_manager<span style="color: #666666">.</span>set_file_paths(known_file_paths)
                    <span style="color: #008000">self</span><span style="color: #666666">.</span>clear_nonexistent_import_errors    (known_file_paths<span style="color: #666666">=</span>known_file_paths)

        simple_dags <span style="color: #666666">=</span> processor_manager<span style="color: #666666">.</span>heartbeat()
</code></pre></div>

<p>The <code>_execute_helper</code> starts the <code>executor</code> and run the <code>processor_manager.heartbeat()</code> in a loop with the configured <code>dag_dir_list_interval</code>.</p>

<h2 id="dagfileprocessormanager-heartbeat">DagFileProcessorManager Heartbeat</h2>

<p>As fast as we know, the <code>processor_manager.heartbeat</code> is the most important method in the process loop, so let&rsquo;s dive into it.</p>

<p><img src="/process_loop_inner/process_loop_inner.svg" alt="process_loop_inner" /></p>

<p>The <code>processor_manager</code> actually maintains a list of DagFileProcessor(<em>don&rsquo;t know how to present this list in the UML sequence diagram</em>) to process the dag files. The max size of the processor list is configured in the <code>airflow.cfg</code> -&gt; <code>scheduler</code>-&gt; <code>max_threads</code>. In the <code>heartbeat</code> method, the <code>processor_manager.heartbeat</code> kick off new <code>DagFileProcessor</code> and <code>DagFileProcessor</code> kick off new <code>multiprocessing. Process</code> to process DAG definition files and read the results from the finished processors. One process corresponds to one <code>SchedulerJob</code> instance. When the process started, it use <code>scheduler_job.process_file</code> method to process the DAG files and stores the result into a queue. The <code>processor_manager</code> collects all the results that were produced by processors that have finished since the last time this was called. it also starts more processors if necessary.</p>

<p><a href="https://github.com/apache/airflow/blob/1.10.1/airflow/utils/dag_processing.py#L473">airflow/utils/dag_processing.py#DagFileProcessorManager.heartbeat</a></p>
<div class="highlight" style="background: #f8f8f8"><pre style="line-height: 125%"><code class="language-python" data-lang="python"><span></span><span style="color: #008000; font-weight: bold">def</span> <span style="color: #0000FF">heartbeat</span>(<span style="color: #008000">self</span>):
    <span style="color: #408080; font-style: italic"># get finished_processors and running_processors</span>
    finished_processors <span style="color: #666666">=</span> {}
    running_processors <span style="color: #666666">=</span> {}
    <span style="color: #008000; font-weight: bold">for</span> file_path, processor <span style="color: #AA22FF; font-weight: bold">in</span> <span style="color: #008000">self</span><span style="color: #666666">.</span>_processors<span style="color: #666666">.</span>items():
        <span style="color: #008000; font-weight: bold">if</span> processor<span style="color: #666666">.</span>done:
            <span style="color: #666666">...</span>
            finished_processors[file_path] <span style="color: #666666">=</span> processor
            <span style="color: #666666">...</span>
        <span style="color: #008000; font-weight: bold">else</span>:
            running_processors[file_path] <span style="color: #666666">=</span> processor
    <span style="color: #008000">self</span><span style="color: #666666">.</span>_processors <span style="color: #666666">=</span> running_processors

    <span style="color: #408080; font-style: italic"># Collect all the DAGs that were found in the processed files</span>
    simple_dags <span style="color: #666666">=</span> []
    <span style="color: #008000; font-weight: bold">for</span> file_path, processor <span style="color: #AA22FF; font-weight: bold">in</span> finished_processors<span style="color: #666666">.</span>items():
        <span style="color: #008000; font-weight: bold">if</span> processor<span style="color: #666666">.</span>result <span style="color: #AA22FF; font-weight: bold">is</span> <span style="color: #008000">None</span>:
            <span style="color: #666666">...</span>
        <span style="color: #008000; font-weight: bold">else</span>:
            <span style="color: #008000; font-weight: bold">for</span> simple_dag <span style="color: #AA22FF; font-weight: bold">in</span> processor<span style="color: #666666">.</span>result:
                simple_dags<span style="color: #666666">.</span>append(simple_dag)

    <span style="color: #408080; font-style: italic"># Generate more file paths to process if we processed all the files</span>
    <span style="color: #408080; font-style: italic"># already.</span>
    <span style="color: #666666">...</span>
    <span style="color: #408080; font-style: italic"># Start more processors if we have enough slots and files to process</span>
    <span style="color: #008000; font-weight: bold">while</span> (<span style="color: #008000">self</span><span style="color: #666666">.</span>_parallelism <span style="color: #666666">-</span> <span style="color: #008000">len</span>(<span style="color: #008000">self</span><span style="color: #666666">.</span>_processors) <span style="color: #666666">&gt;</span> <span style="color: #666666">0</span> <span style="color: #AA22FF; font-weight: bold">and</span> <span style="color: #008000">len</span>    (<span style="color: #008000">self</span><span style="color: #666666">.</span>_file_path_queue) <span style="color: #666666">&gt;</span> <span style="color: #666666">0</span>):
        file_path <span style="color: #666666">=</span> <span style="color: #008000">self</span><span style="color: #666666">.</span>_file_path_queue<span style="color: #666666">.</span>pop(<span style="color: #666666">0</span>)
        processor <span style="color: #666666">=</span> <span style="color: #008000">self</span><span style="color: #666666">.</span>_processor_factory(file_path)

        processor<span style="color: #666666">.</span>start()
        <span style="color: #008000">self</span><span style="color: #666666">.</span>_processors[file_path] <span style="color: #666666">=</span> processor
    <span style="color: #408080; font-style: italic"># Update scheduler heartbeat count.</span>
    <span style="color: #666666">...</span>
    <span style="color: #008000; font-weight: bold">return</span> simple_dags
</code></pre></div>

<p><a href="https://github.com/apache/airflow/blob/1.10.1/airflow/jobs.py#L301">airflow/jobs.py#DagFileProcessor</a></p>
<div class="highlight" style="background: #f8f8f8"><pre style="line-height: 125%"><code class="language-python" data-lang="python"><span></span><span style="color: #008000; font-weight: bold">class</span> <span style="color: #0000FF; font-weight: bold">DagFileProcessor</span>(AbstractDagFileProcessor, LoggingMixin):
    <span style="color: #666666">...</span>
    <span style="color: #008000; font-weight: bold">def</span> <span style="color: #0000FF">_launch_process</span>(result_queue,<span style="color: #666666">...</span>):
        <span style="color: #666666">...</span>
        <span style="color: #008000; font-weight: bold">def</span> <span style="color: #0000FF">helper</span>()
            scheduler_job <span style="color: #666666">=</span> SchedulerJob(dag_ids<span style="color: #666666">=</span>dag_id_white_list, log<span style="color: #666666">=</span>log)
            result <span style="color: #666666">=</span> scheduler_job<span style="color: #666666">.</span>process_file(file_path, pickle_dags)
            result_queue<span style="color: #666666">.</span>put(result)
        <span style="color: #666666">...</span>
        p <span style="color: #666666">=</span> multiprocessing<span style="color: #666666">.</span>Process(target<span style="color: #666666">=</span>helper,
                                    args<span style="color: #666666">=</span>(),
                                    name<span style="color: #666666">=</span><span style="color: #BA2121">&quot;{}-Process&quot;</span><span style="color: #666666">.</span>format(thread_name))
        p<span style="color: #666666">.</span>start()
        <span style="color: #008000; font-weight: bold">return</span> p
    <span style="color: #666666">...</span>
    <span style="color: #008000; font-weight: bold">def</span> <span style="color: #0000FF">start</span>(<span style="color: #008000">self</span>):
        <span style="color: #BA2121; font-style: italic">&quot;&quot;&quot;</span>
<span style="color: #BA2121; font-style: italic">        Launch the process and start processing the DAG.</span>
<span style="color: #BA2121; font-style: italic">        &quot;&quot;&quot;</span>
        <span style="color: #008000">self</span><span style="color: #666666">.</span>_process <span style="color: #666666">=</span> DagFileProcessor<span style="color: #666666">.</span>_launch_process(
            <span style="color: #008000">self</span><span style="color: #666666">.</span>_result_queue,
            <span style="color: #008000">self</span><span style="color: #666666">.</span>file_path,
            <span style="color: #008000">self</span><span style="color: #666666">.</span>_pickle_dags,
            <span style="color: #008000">self</span><span style="color: #666666">.</span>_dag_id_white_list,
            <span style="color: #BA2121">&quot;DagFileProcessor{}&quot;</span><span style="color: #666666">.</span>format(<span style="color: #008000">self</span><span style="color: #666666">.</span>_instance_id))
        <span style="color: #008000">self</span><span style="color: #666666">.</span>_start_time <span style="color: #666666">=</span> timezone<span style="color: #666666">.</span>utcnow()
</code></pre></div>

<h2 id="schedulejob-process-file">ScheduleJob Process File</h2>

<p>Let&rsquo;s keep diving into the <code>scheduler_job.process_file</code> method.</p>

<p><img src="/process_file/process_file.svg" alt="process_file" /></p>

<p>The <code>scheduler_job.process_file</code> method first creates a <code>DagBag</code> instance for the dag file path. In the <code>DagBag</code> instance initiation, it loads the python modules in the file path using different std lib base on whether the path is a zip path.
After modules are loaded, <code>DagBag</code> collects all the DAGs in the modules.
ScheduleJob then gets all dags from <code>DagBag</code>, sync their states db and collect those dags which are not paused.</p>

<p>ScheduleJob iterates over all the un-paused dags and processes them. Processing includes:</p>

<ol>
<li>Calculate <code>next_run_date</code> for dag and create appropriate <code>DagRun(s)</code> in the DB.</li>
<li>Create appropriate <code>TaskInstance(s)</code> in the DB for new <code>DagRuns</code>.</li>
<li>Find all active <code>DagRuns</code> for a dag and iterate over their unscheduled <code>TaskInstances</code>. If the dependencies of a <code>TaskInstance</code> is met, update the state of the <code>TaskInstance</code> to SCHEDULED.</li>
<li>Send emails for tasks that have missed SLAs.</li>
</ol>

<p><a href="https://github.com/apache/airflow/blob/1.10.1/airflow/jobs.py#L1771">airflow/jobs.py#ScheduleJob.process_file</a></p>
<div class="highlight" style="background: #f8f8f8"><pre style="line-height: 125%"><code class="language-python" data-lang="python"><span></span><span style="color: #008000; font-weight: bold">def</span> <span style="color: #0000FF">process_file</span>(<span style="color: #008000">self</span>, file_path, pickle_dags<span style="color: #666666">=</span><span style="color: #008000">False</span>, session<span style="color: #666666">=</span><span style="color: #008000">None</span>):
    simple_dags <span style="color: #666666">=</span> []

    <span style="color: #008000; font-weight: bold">try</span>:
        dagbag <span style="color: #666666">=</span> models<span style="color: #666666">.</span>DagBag(file_path)
    <span style="color: #008000; font-weight: bold">except</span> <span style="color: #D2413A; font-weight: bold">Exception</span>:
        <span style="color: #666666">...</span>
        <span style="color: #008000; font-weight: bold">return</span> []
    <span style="color: #666666">...</span>
    <span style="color: #408080; font-style: italic"># Save individual DAGs in the ORM and update DagModel.last_scheduled_time</span>
    <span style="color: #008000; font-weight: bold">for</span> dag <span style="color: #AA22FF; font-weight: bold">in</span> dagbag<span style="color: #666666">.</span>dags<span style="color: #666666">.</span>values():
        dag<span style="color: #666666">.</span>sync_to_db()

    paused_dag_ids <span style="color: #666666">=</span> [dag<span style="color: #666666">.</span>dag_id <span style="color: #008000; font-weight: bold">for</span> dag <span style="color: #AA22FF; font-weight: bold">in</span> dagbag<span style="color: #666666">.</span>dags<span style="color: #666666">.</span>values() <span style="color: #008000; font-weight: bold">if</span> dag<span style="color: #666666">.</span>is_paused]

    <span style="color: #408080; font-style: italic"># Pickle the DAGs (if necessary) and put them into a SimpleDag</span>
    <span style="color: #008000; font-weight: bold">for</span> dag_id <span style="color: #AA22FF; font-weight: bold">in</span> dagbag<span style="color: #666666">.</span>dags:
        dag <span style="color: #666666">=</span> dagbag<span style="color: #666666">.</span>get_dag(dag_id)
        <span style="color: #666666">...</span>
        <span style="color: #408080; font-style: italic"># Only return DAGs that are not paused</span>
        <span style="color: #008000; font-weight: bold">if</span> dag_id <span style="color: #AA22FF; font-weight: bold">not</span> <span style="color: #AA22FF; font-weight: bold">in</span> paused_dag_ids:
            simple_dags<span style="color: #666666">.</span>append(SimpleDag(dag, pickle_id<span style="color: #666666">=</span>pickle_id))

    <span style="color: #008000; font-weight: bold">if</span> <span style="color: #008000">len</span>(<span style="color: #008000">self</span><span style="color: #666666">.</span>dag_ids) <span style="color: #666666">&gt;</span> <span style="color: #666666">0</span>:
        dags <span style="color: #666666">=</span> [dag <span style="color: #008000; font-weight: bold">for</span> dag <span style="color: #AA22FF; font-weight: bold">in</span> dagbag<span style="color: #666666">.</span>dags<span style="color: #666666">.</span>values()
                <span style="color: #008000; font-weight: bold">if</span> dag<span style="color: #666666">.</span>dag_id <span style="color: #AA22FF; font-weight: bold">in</span> <span style="color: #008000">self</span><span style="color: #666666">.</span>dag_ids <span style="color: #AA22FF; font-weight: bold">and</span>
                dag<span style="color: #666666">.</span>dag_id <span style="color: #AA22FF; font-weight: bold">not</span> <span style="color: #AA22FF; font-weight: bold">in</span> paused_dag_ids]
    <span style="color: #008000; font-weight: bold">else</span>:
        dags <span style="color: #666666">=</span> [dag <span style="color: #008000; font-weight: bold">for</span> dag <span style="color: #AA22FF; font-weight: bold">in</span> dagbag<span style="color: #666666">.</span>dags<span style="color: #666666">.</span>values()
                <span style="color: #008000; font-weight: bold">if</span> <span style="color: #AA22FF; font-weight: bold">not</span> dag<span style="color: #666666">.</span>parent_dag <span style="color: #AA22FF; font-weight: bold">and</span>
                dag<span style="color: #666666">.</span>dag_id <span style="color: #AA22FF; font-weight: bold">not</span> <span style="color: #AA22FF; font-weight: bold">in</span> paused_dag_ids]

    <span style="color: #408080; font-style: italic"># Not using multiprocessing.Queue() since it&#39;s no longer a separate</span>
    <span style="color: #408080; font-style: italic"># process and due to some unusual behavior. (empty() incorrectly</span>
    <span style="color: #408080; font-style: italic"># returns true?)</span>
    ti_keys_to_schedule <span style="color: #666666">=</span> []
    <span style="color: #008000">self</span><span style="color: #666666">.</span>_process_dags(dagbag, dags, ti_keys_to_schedule)

    <span style="color: #008000; font-weight: bold">for</span> ti_key <span style="color: #AA22FF; font-weight: bold">in</span> ti_keys_to_schedule:
        dag <span style="color: #666666">=</span> dagbag<span style="color: #666666">.</span>dags[ti_key[<span style="color: #666666">0</span>]]
        task <span style="color: #666666">=</span> dag<span style="color: #666666">.</span>get_task(ti_key[<span style="color: #666666">1</span>])
        <span style="color: #408080; font-style: italic"># NOTE: create TaskInstance</span>
        ti <span style="color: #666666">=</span> models<span style="color: #666666">.</span>TaskInstance(task, ti_key[<span style="color: #666666">2</span>])
        ti<span style="color: #666666">.</span>refresh_from_db(session<span style="color: #666666">=</span>session, lock_for_update<span style="color: #666666">=</span><span style="color: #008000">True</span>)
        <span style="color: #666666">...</span>
        dep_context <span style="color: #666666">=</span> DepContext(deps<span style="color: #666666">=</span>QUEUE_DEPS, ignore_task_deps<span style="color: #666666">=</span><span style="color: #008000">True</span>)
        <span style="color: #666666">...</span>
        <span style="color: #008000; font-weight: bold">if</span> ti<span style="color: #666666">.</span>are_dependencies_met(
                dep_context<span style="color: #666666">=</span>dep_context,
                session<span style="color: #666666">=</span>session,
                verbose<span style="color: #666666">=</span><span style="color: #008000">True</span>):
            <span style="color: #408080; font-style: italic"># Task starts out in the scheduled state. All tasks in the</span>
            <span style="color: #408080; font-style: italic"># scheduled state will be sent to the executor</span>
            ti<span style="color: #666666">.</span>state <span style="color: #666666">=</span> State<span style="color: #666666">.</span>SCHEDULED

        <span style="color: #408080; font-style: italic"># Also save this task instance to the DB.</span>
        <span style="color: #008000">self</span><span style="color: #666666">.</span>log<span style="color: #666666">.</span>info(<span style="color: #BA2121">&quot;Creating / updating </span><span style="color: #BB6688; font-weight: bold">%s</span><span style="color: #BA2121"> in ORM&quot;</span>, ti)
        session<span style="color: #666666">.</span>merge(ti)
    <span style="color: #408080; font-style: italic"># commit batch</span>
    session<span style="color: #666666">.</span>commit()

    <span style="color: #408080; font-style: italic"># Record import errors into the ORM</span>
    <span style="color: #666666">...</span>
    <span style="color: #408080; font-style: italic"># kill_zombies</span>
    <span style="color: #666666">...</span>

    <span style="color: #008000; font-weight: bold">return</span> simple_dags
</code></pre></div>

<p><a href="https://github.com/apache/airflow/blob/1.10.1/airflow/models/__init__.py#L265">airflow/models/__init__.py#DagBag.process_file</a></p>
<div class="highlight" style="background: #f8f8f8"><pre style="line-height: 125%"><code class="language-python" data-lang="python"><span></span>    <span style="color: #008000; font-weight: bold">def</span> <span style="color: #0000FF">process_file</span>(<span style="color: #008000">self</span>, filepath, only_if_updated<span style="color: #666666">=</span><span style="color: #008000">True</span>, safe_mode<span style="color: #666666">=</span><span style="color: #008000">True</span>):
        <span style="color: #666666">...</span>
        mods <span style="color: #666666">=</span> []
        is_zipfile <span style="color: #666666">=</span> zipfile<span style="color: #666666">.</span>is_zipfile(filepath)
        <span style="color: #008000; font-weight: bold">if</span> <span style="color: #AA22FF; font-weight: bold">not</span> is_zipfile:
            <span style="color: #666666">...</span>
            org_mod_name, _ <span style="color: #666666">=</span> os<span style="color: #666666">.</span>path<span style="color: #666666">.</span>splitext(os<span style="color: #666666">.</span>path<span style="color: #666666">.</span>split(filepath)[<span style="color: #666666">-1</span>])
            mod_name <span style="color: #666666">=</span> <span style="color: #666666">...</span>
            <span style="color: #666666">...</span>
            <span style="color: #008000; font-weight: bold">with</span> timeout(configuration<span style="color: #666666">.</span>conf<span style="color: #666666">.</span>getint(<span style="color: #BA2121">&#39;core&#39;</span>, <span style="color: #BA2121">&quot;DAGBAG_IMPORT_TIMEOUT&quot;</span>)):
                <span style="color: #008000; font-weight: bold">try</span>:
                    m <span style="color: #666666">=</span> imp<span style="color: #666666">.</span>load_source(mod_name, filepath)
                    mods<span style="color: #666666">.</span>append(m)
                <span style="color: #008000; font-weight: bold">except</span> <span style="color: #D2413A; font-weight: bold">Exception</span> <span style="color: #008000; font-weight: bold">as</span> e:
                    <span style="color: #666666">...</span>
        <span style="color: #008000; font-weight: bold">else</span>:
            zip_file <span style="color: #666666">=</span> zipfile<span style="color: #666666">.</span>ZipFile(filepath)
            <span style="color: #008000; font-weight: bold">for</span> mod <span style="color: #AA22FF; font-weight: bold">in</span> zip_file<span style="color: #666666">.</span>infolist():
                head, _ <span style="color: #666666">=</span> os<span style="color: #666666">.</span>path<span style="color: #666666">.</span>split(mod<span style="color: #666666">.</span>filename)
                mod_name, ext <span style="color: #666666">=</span> os<span style="color: #666666">.</span>path<span style="color: #666666">.</span>splitext(mod<span style="color: #666666">.</span>filename)
                <span style="color: #008000; font-weight: bold">if</span> <span style="color: #AA22FF; font-weight: bold">not</span> head <span style="color: #AA22FF; font-weight: bold">and</span> (ext <span style="color: #666666">==</span> <span style="color: #BA2121">&#39;.py&#39;</span> <span style="color: #AA22FF; font-weight: bold">or</span> ext <span style="color: #666666">==</span> <span style="color: #BA2121">&#39;.pyc&#39;</span>):
                    <span style="color: #666666">...</span>
                    <span style="color: #008000; font-weight: bold">try</span>:
                        sys<span style="color: #666666">.</span>path<span style="color: #666666">.</span>insert(<span style="color: #666666">0</span>, filepath)
                        m <span style="color: #666666">=</span> importlib<span style="color: #666666">.</span>import_module(mod_name)
                        mods<span style="color: #666666">.</span>append(m)
                    <span style="color: #008000; font-weight: bold">except</span> <span style="color: #D2413A; font-weight: bold">Exception</span> <span style="color: #008000; font-weight: bold">as</span> e:
                        <span style="color: #666666">...</span>
        <span style="color: #008000; font-weight: bold">for</span> m <span style="color: #AA22FF; font-weight: bold">in</span> mods:
            <span style="color: #008000; font-weight: bold">for</span> dag <span style="color: #AA22FF; font-weight: bold">in</span> <span style="color: #008000">list</span>(m<span style="color: #666666">.</span><span style="color: #19177C">__dict__</span><span style="color: #666666">.</span>values()):
                <span style="color: #008000; font-weight: bold">if</span> <span style="color: #008000">isinstance</span>(dag, DAG):
                    <span style="color: #666666">...</span>
                    <span style="color: #008000; font-weight: bold">try</span>:
                        dag<span style="color: #666666">.</span>is_subdag <span style="color: #666666">=</span> <span style="color: #008000">False</span>
                        <span style="color: #008000">self</span><span style="color: #666666">.</span>bag_dag(dag, parent_dag<span style="color: #666666">=</span>dag, root_dag<span style="color: #666666">=</span>dag)
                        <span style="color: #008000; font-weight: bold">if</span> <span style="color: #008000">isinstance</span>(dag<span style="color: #666666">.</span>_schedule_interval, six<span style="color: #666666">.</span>string_types):
                            croniter(dag<span style="color: #666666">.</span>_schedule_interval)
                        found_dags<span style="color: #666666">.</span>append(dag)
                        found_dags <span style="color: #666666">+=</span> dag<span style="color: #666666">.</span>subdags
                    <span style="color: #008000; font-weight: bold">except</span> <span style="color: #666666">...</span>
        <span style="color: #008000">self</span><span style="color: #666666">.</span>file_last_changed[filepath] <span style="color: #666666">=</span> file_last_changed_on_disk
        <span style="color: #008000; font-weight: bold">return</span> found_dags
</code></pre></div>

<p><a href="https://github.com/apache/airflow/blob/1.10.1/airflow/jobs.py#L1398">airflow/jobs.py#ScheduleJob._process_dags</a></p>
<div class="highlight" style="background: #f8f8f8"><pre style="line-height: 125%"><code class="language-python" data-lang="python"><span></span><span style="color: #008000; font-weight: bold">def</span> <span style="color: #0000FF">_process_dags</span>(<span style="color: #008000">self</span>, dagbag, dags, tis_out):
    <span style="color: #008000; font-weight: bold">for</span> dag <span style="color: #AA22FF; font-weight: bold">in</span> dags:
        <span style="color: #666666">...</span>
        dag_run <span style="color: #666666">=</span> <span style="color: #008000">self</span><span style="color: #666666">.</span>create_dag_run(dag)
        <span style="color: #008000; font-weight: bold">if</span> dag_run:
            <span style="color: #008000">self</span><span style="color: #666666">.</span>log<span style="color: #666666">.</span>info(<span style="color: #BA2121">&quot;Created </span><span style="color: #BB6688; font-weight: bold">%s</span><span style="color: #BA2121">&quot;</span>, dag_run)
        <span style="color: #008000">self</span><span style="color: #666666">.</span>_process_task_instances(dag, tis_out)
        <span style="color: #008000">self</span><span style="color: #666666">.</span>manage_slas(dag)

    models<span style="color: #666666">.</span>DagStat<span style="color: #666666">.</span>update([d<span style="color: #666666">.</span>dag_id <span style="color: #008000; font-weight: bold">for</span> d <span style="color: #AA22FF; font-weight: bold">in</span> dags])
</code></pre></div>

<p><a href="https://github.com/apache/airflow/blob/1.10.1/airflow/jobs.py#L783">airflow/jobs.py#ScheduleJob.create_dag_run</a></p>
<div class="highlight" style="background: #f8f8f8"><pre style="line-height: 125%"><code class="language-python" data-lang="python"><span></span><span style="color: #008000; font-weight: bold">def</span> <span style="color: #0000FF">create_dag_run</span>(<span style="color: #008000">self</span>, dag, session<span style="color: #666666">=</span><span style="color: #008000">None</span>):
    <span style="color: #BA2121; font-style: italic">&quot;&quot;&quot;</span>
<span style="color: #BA2121; font-style: italic">    This method checks whether a new DagRun needs to be created</span>
<span style="color: #BA2121; font-style: italic">    for a DAG based on scheduling interval</span>
<span style="color: #BA2121; font-style: italic">    Returns DagRun if one is scheduled. Otherwise returns None.</span>
<span style="color: #BA2121; font-style: italic">    &quot;&quot;&quot;</span>
    <span style="color: #008000; font-weight: bold">if</span> dag<span style="color: #666666">.</span>schedule_interval:
        active_runs <span style="color: #666666">=</span> DagRun<span style="color: #666666">.</span>find(<span style="color: #666666">...</span>)
        <span style="color: #408080; font-style: italic"># return if already reached maximum active runs and no timeout setting</span>
        <span style="color: #008000; font-weight: bold">if</span> <span style="color: #008000">len</span>(active_runs) <span style="color: #666666">&gt;=</span> dag<span style="color: #666666">.</span>max_active_runs <span style="color: #AA22FF; font-weight: bold">and</span> <span style="color: #AA22FF; font-weight: bold">not</span> dag<span style="color: #666666">.</span>dagrun_timeout:
            <span style="color: #008000; font-weight: bold">return</span>
        timedout_runs <span style="color: #666666">=</span> <span style="color: #666666">0</span>
        <span style="color: #008000; font-weight: bold">for</span> dr <span style="color: #AA22FF; font-weight: bold">in</span> active_runs:
            <span style="color: #008000; font-weight: bold">if</span> (dr<span style="color: #666666">.</span>start_date <span style="color: #AA22FF; font-weight: bold">and</span> dag<span style="color: #666666">.</span>dagrun_timeout <span style="color: #AA22FF; font-weight: bold">and</span> dr<span style="color: #666666">.</span>start_date <span style="color: #666666">&lt;</span> timezone<span style="color: #666666">.</span>utcnow() <span style="color: #666666">-</span> dag<span style="color: #666666">.</span>dagrun_timeout):
                dr<span style="color: #666666">.</span>state <span style="color: #666666">=</span> State<span style="color: #666666">.</span>FAILED
                dr<span style="color: #666666">.</span>end_date <span style="color: #666666">=</span> timezone<span style="color: #666666">.</span>utcnow()
                dag<span style="color: #666666">.</span>handle_callback(dr, success<span style="color: #666666">=</span><span style="color: #008000">False</span>, reason<span style="color: #666666">=</span><span style="color: #BA2121">&#39;dagrun_timeout&#39;</span>,  dsession<span style="color: #666666">=</span>session)
                timedout_runs <span style="color: #666666">+=</span> <span style="color: #666666">1</span>
        session<span style="color: #666666">.</span>commit()
        <span style="color: #008000; font-weight: bold">if</span> <span style="color: #008000">len</span>(active_runs) <span style="color: #666666">-</span> timedout_runs <span style="color: #666666">&gt;=</span> dag<span style="color: #666666">.</span>max_active_runs:
            <span style="color: #008000; font-weight: bold">return</span>

        <span style="color: #408080; font-style: italic"># this query should be replaced by find dagrun</span>
        last_scheduled_run <span style="color: #666666">=</span> session<span style="color: #666666">.</span>query(func<span style="color: #666666">.</span>max(DagRun<span style="color: #666666">.</span>execution_date))<span style="color: #666666">.</span>filter_by(<span style="color: #666666">...</span>)<span style="color: #666666">.</span>scalar()

        <span style="color: #408080; font-style: italic"># don&#39;t schedule @once again</span>
        <span style="color: #008000; font-weight: bold">if</span> dag<span style="color: #666666">.</span>schedule_interval <span style="color: #666666">==</span> <span style="color: #BA2121">&#39;@once&#39;</span> <span style="color: #AA22FF; font-weight: bold">and</span> last_scheduled_run:
            <span style="color: #008000; font-weight: bold">return</span> <span style="color: #008000">None</span>

        <span style="color: #408080; font-style: italic"># don&#39;t do scheduler catchup for dag&#39;s that don&#39;t have dag.catchup = True</span>
        <span style="color: #008000; font-weight: bold">if</span> <span style="color: #AA22FF; font-weight: bold">not</span> (dag<span style="color: #666666">.</span>catchup <span style="color: #AA22FF; font-weight: bold">or</span> dag<span style="color: #666666">.</span>schedule_interval <span style="color: #666666">==</span> <span style="color: #BA2121">&#39;@once&#39;</span>):
            <span style="color: #666666">...</span>
            dag<span style="color: #666666">.</span>start_date <span style="color: #666666">=</span> <span style="color: #666666">...</span> <span style="color: #408080; font-style: italic"># next_schedule_time_before_now</span>

        next_run_date <span style="color: #666666">=</span> <span style="color: #008000">None</span>
        <span style="color: #008000; font-weight: bold">if</span> <span style="color: #AA22FF; font-weight: bold">not</span> last_scheduled_run:
            <span style="color: #408080; font-style: italic"># First run</span>
            next_run_date <span style="color: #666666">=</span> <span style="color: #666666">...</span> <span style="color: #408080; font-style: italic"># minimal start_time of dag tasks</span>
        <span style="color: #008000; font-weight: bold">else</span>:
            next_run_date <span style="color: #666666">=</span> dag<span style="color: #666666">.</span>following_schedule(last_scheduled_run)

        <span style="color: #408080; font-style: italic"># make sure backfills are also considered</span>
        <span style="color: #666666">...</span>

        <span style="color: #408080; font-style: italic"># don&#39;t ever schedule prior to the dag&#39;s start_date</span>
        <span style="color: #666666">...</span>

        <span style="color: #408080; font-style: italic"># don&#39;t ever schedule in the future</span>
        <span style="color: #666666">...</span>

        <span style="color: #408080; font-style: italic"># this structure is necessary to avoid a TypeError from concatenating</span>
        <span style="color: #408080; font-style: italic"># NoneType</span>
        <span style="color: #008000; font-weight: bold">if</span> dag<span style="color: #666666">.</span>schedule_interval <span style="color: #666666">==</span> <span style="color: #BA2121">&#39;@once&#39;</span>:
            period_end <span style="color: #666666">=</span> next_run_date
        <span style="color: #008000; font-weight: bold">elif</span> next_run_date:
            period_end <span style="color: #666666">=</span> dag<span style="color: #666666">.</span>following_schedule(next_run_date)

        <span style="color: #408080; font-style: italic"># Don&#39;t schedule a dag beyond its end_date (as specified by the dag param)</span>
        <span style="color: #008000; font-weight: bold">if</span> next_run_date <span style="color: #AA22FF; font-weight: bold">and</span> dag<span style="color: #666666">.</span>end_date <span style="color: #AA22FF; font-weight: bold">and</span> next_run_date <span style="color: #666666">&gt;</span> dag<span style="color: #666666">.</span>end_date:
            <span style="color: #008000; font-weight: bold">return</span>

        <span style="color: #408080; font-style: italic"># Don&#39;t schedule a dag beyond its end_date (as specified by the task params)</span>
        <span style="color: #408080; font-style: italic"># Get the min task end date, which may come from the dag.default_args</span>
        <span style="color: #666666">...</span>

        <span style="color: #008000; font-weight: bold">if</span> next_run_date <span style="color: #AA22FF; font-weight: bold">and</span> period_end <span style="color: #AA22FF; font-weight: bold">and</span> period_end <span style="color: #666666">&lt;=</span> timezone<span style="color: #666666">.</span>utcnow():
            <span style="color: #408080; font-style: italic"># create a dagrun and save it to db</span>
            next_run <span style="color: #666666">=</span> dag<span style="color: #666666">.</span>create_dagrun(
                run_id<span style="color: #666666">=</span>DagRun<span style="color: #666666">.</span>ID_PREFIX <span style="color: #666666">+</span> next_run_date<span style="color: #666666">.</span>isoformat(),
                execution_date<span style="color: #666666">=</span>next_run_date,
                start_date<span style="color: #666666">=</span>timezone<span style="color: #666666">.</span>utcnow(),
                state<span style="color: #666666">=</span>State<span style="color: #666666">.</span>RUNNING,
                external_trigger<span style="color: #666666">=</span><span style="color: #008000">False</span>
            )
            <span style="color: #008000; font-weight: bold">return</span> next_run
</code></pre></div>

<p><a href="https://github.com/apache/airflow/blob/1.10.1/airflow/jobs.py#L914">airflow/jobs.py##ScheduleJob._process_task_instances</a></p>
<div class="highlight" style="background: #f8f8f8"><pre style="line-height: 125%"><code class="language-python" data-lang="python"><span></span><span style="color: #AA22FF">@provide_session</span>
<span style="color: #008000; font-weight: bold">def</span> <span style="color: #0000FF">_process_task_instances</span>(<span style="color: #008000">self</span>, dag, queue, session<span style="color: #666666">=</span><span style="color: #008000">None</span>):
    <span style="color: #BA2121; font-style: italic">&quot;&quot;&quot;</span>
<span style="color: #BA2121; font-style: italic">    This method schedules the tasks for a single DAG by looking at the</span>
<span style="color: #BA2121; font-style: italic">    active DAG runs and adding task instances that should run to the</span>
<span style="color: #BA2121; font-style: italic">    queue.</span>
<span style="color: #BA2121; font-style: italic">    &quot;&quot;&quot;</span>

    <span style="color: #408080; font-style: italic"># update the state of the previously active dag runs</span>
    dag_runs <span style="color: #666666">=</span> DagRun<span style="color: #666666">.</span>find(dag_id<span style="color: #666666">=</span>dag<span style="color: #666666">.</span>dag_id, state<span style="color: #666666">=</span>State<span style="color: #666666">.</span>RUNNING, session<span style="color: #666666">=</span>session)
    active_dag_runs <span style="color: #666666">=</span> []
    <span style="color: #008000; font-weight: bold">for</span> run <span style="color: #AA22FF; font-weight: bold">in</span> dag_runs:
        <span style="color: #008000">self</span><span style="color: #666666">.</span>log<span style="color: #666666">.</span>info(<span style="color: #BA2121">&quot;Examining DAG run </span><span style="color: #BB6688; font-weight: bold">%s</span><span style="color: #BA2121">&quot;</span>, run)
        <span style="color: #408080; font-style: italic"># don&#39;t consider runs that are executed in the future</span>
        <span style="color: #666666">...</span>

        <span style="color: #008000; font-weight: bold">if</span> <span style="color: #008000">len</span>(active_dag_runs) <span style="color: #666666">&gt;=</span> dag<span style="color: #666666">.</span>max_active_runs:
            <span style="color: #008000">self</span><span style="color: #666666">.</span>log<span style="color: #666666">.</span>info(<span style="color: #BA2121">&quot;Active dag runs &gt; max_active_run.&quot;</span>)
            <span style="color: #008000; font-weight: bold">continue</span>

        <span style="color: #408080; font-style: italic"># skip backfill dagruns for now as long as they are not really scheduled</span>
        <span style="color: #008000; font-weight: bold">if</span> run<span style="color: #666666">.</span>is_backfill:
            <span style="color: #008000; font-weight: bold">continue</span>

        <span style="color: #408080; font-style: italic"># todo: run.dag is transient but needs to be set</span>
        run<span style="color: #666666">.</span>dag <span style="color: #666666">=</span> dag
        <span style="color: #408080; font-style: italic"># todo: preferably the integrity check happens at dag collection time</span>
        run<span style="color: #666666">.</span>verify_integrity(session<span style="color: #666666">=</span>session)
        run<span style="color: #666666">.</span>update_state(session<span style="color: #666666">=</span>session)
        <span style="color: #008000; font-weight: bold">if</span> run<span style="color: #666666">.</span>state <span style="color: #666666">==</span> State<span style="color: #666666">.</span>RUNNING:
            make_transient(run)
            active_dag_runs<span style="color: #666666">.</span>append(run)

    <span style="color: #008000; font-weight: bold">for</span> run <span style="color: #AA22FF; font-weight: bold">in</span> active_dag_runs:
        <span style="color: #008000">self</span><span style="color: #666666">.</span>log<span style="color: #666666">.</span>debug(<span style="color: #BA2121">&quot;Examining active DAG run: </span><span style="color: #BB6688; font-weight: bold">%s</span><span style="color: #BA2121">&quot;</span>, run)
        <span style="color: #408080; font-style: italic"># this needs a fresh session sometimes tis get detached</span>
        <span style="color: #408080; font-style: italic"># Get a set of task instance related to this task for a specific date range.</span>
        tis <span style="color: #666666">=</span> run<span style="color: #666666">.</span>get_task_instances(state<span style="color: #666666">=</span>(State<span style="color: #666666">.</span>NONE, State<span style="color: #666666">.</span>UP_FOR_RETRY))

        <span style="color: #408080; font-style: italic"># this loop is quite slow as it uses are_dependencies_met for</span>
        <span style="color: #408080; font-style: italic"># every task (in ti.is_runnable). This is also called in</span>
        <span style="color: #408080; font-style: italic"># update_state above which has already checked these tasks</span>
        <span style="color: #008000; font-weight: bold">for</span> ti <span style="color: #AA22FF; font-weight: bold">in</span> tis:
            task <span style="color: #666666">=</span> dag<span style="color: #666666">.</span>get_task(ti<span style="color: #666666">.</span>task_id)

            <span style="color: #408080; font-style: italic"># fixme: ti.task is transient but needs to be set</span>
            ti<span style="color: #666666">.</span>task <span style="color: #666666">=</span> task

            <span style="color: #408080; font-style: italic"># future: remove adhoc</span>
            <span style="color: #008000; font-weight: bold">if</span> task<span style="color: #666666">.</span>adhoc:
                <span style="color: #008000; font-weight: bold">continue</span>

            <span style="color: #008000; font-weight: bold">if</span> ti<span style="color: #666666">.</span>are_dependencies_met(
                    dep_context<span style="color: #666666">=</span>DepContext(flag_upstream_failed<span style="color: #666666">=</span><span style="color: #008000">True</span>),
                    session<span style="color: #666666">=</span>session):
                <span style="color: #008000">self</span><span style="color: #666666">.</span>log<span style="color: #666666">.</span>debug(<span style="color: #BA2121">&#39;Queuing task: </span><span style="color: #BB6688; font-weight: bold">%s</span><span style="color: #BA2121">&#39;</span>, ti)
                queue<span style="color: #666666">.</span>append(ti<span style="color: #666666">.</span>key)
</code></pre></div>

<h2 id="overview">Overview</h2>

<p>The Airflow scheduler spins up a process loop, which monitors and stays in sync with a folder for all DAG objects it may contain, and periodically (every minute or so) collects DAG parsing results and inspects active tasks to see whether they can be scheduled.</p>

<h2 id="reference">Reference</h2>

<ul>
<li><a href="https://airflow.apache.org/scheduler.html">Scheduling &amp; Triggers — Airflow Documentation</a></li>
</ul>
    </div>

    
    


    
    

    <footer class="post-footer">
      <div class="post-tags">
          <a href="https://blog.kk17.net/tags/airflow/">airflow</a>
          
        </div>

      
      <nav class="post-nav">
        
        
          <a class="next" href="/post/understand-airflow/">
            <span class="next-text nav-default">Understand Airflow</span>
            <span class="prev-text nav-mobile">Next</span>
            
            <i class="iconfont">
              <svg class="icon" viewBox="0 0 1024 1024" version="1.1"
  xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink"
  width="18" height="18">
  <path d="M332.091514 74.487481l-75.369571 89.491197c-10.963703 12.998035-10.285251 32.864502 1.499144 44.378743l286.278095 300.375162L266.565125 819.058374c-11.338233 12.190647-11.035334 32.285311 0.638543 44.850487l80.46666 86.564541c11.680017 12.583596 30.356378 12.893658 41.662889 0.716314l377.434212-421.426145c11.332093-12.183484 11.041474-32.266891-0.657986-44.844348l-80.46666-86.564541c-1.772366-1.910513-3.706415-3.533476-5.750981-4.877077L373.270379 71.774697C361.493148 60.273758 343.054193 61.470003 332.091514 74.487481z"></path>
</svg>

            </i>
          </a>
      </nav>
    </footer>
  </article>

  
  

  
  

  
  
    <div class="post bg-white">
      <script src="https://utteranc.es/client.js"
            repo= "kk17/blog"
            issue-term="pathname"
            crossorigin="anonymous"
            async>
      </script>
    </div>
  

  

  

  
  
    



        </div>
      </div>
    </main>

    <footer id="footer" class="footer">
      <div class="icon-links">
  
  
    <a href="https://github.com/kk17" rel="me noopener" class="iconfont"
      title="github"  target="_blank"
      >
      <svg class="icon" style="" viewBox="0 0 1024 1024" version="1.1"
  xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink"
  width="36" height="36">
  <path d="M512 12.672c-282.88 0-512 229.248-512 512 0 226.261333 146.688 418.133333 350.08 485.76 25.6 4.821333 34.986667-11.008 34.986667-24.618667 0-12.16-0.426667-44.373333-0.64-87.04-142.421333 30.890667-172.458667-68.693333-172.458667-68.693333C188.672 770.986667 155.008 755.2 155.008 755.2c-46.378667-31.744 3.584-31.104 3.584-31.104 51.413333 3.584 78.421333 52.736 78.421333 52.736 45.653333 78.293333 119.850667 55.68 149.12 42.581333 4.608-33.109333 17.792-55.68 32.426667-68.48-113.706667-12.8-233.216-56.832-233.216-253.013333 0-55.893333 19.84-101.546667 52.693333-137.386667-5.76-12.928-23.04-64.981333 4.48-135.509333 0 0 42.88-13.738667 140.8 52.48 40.96-11.392 84.48-17.024 128-17.28 43.52 0.256 87.04 5.888 128 17.28 97.28-66.218667 140.16-52.48 140.16-52.48 27.52 70.528 10.24 122.581333 5.12 135.509333 32.64 35.84 52.48 81.493333 52.48 137.386667 0 196.693333-119.68 240-233.6 252.586667 17.92 15.36 34.56 46.762667 34.56 94.72 0 68.522667-0.64 123.562667-0.64 140.202666 0 13.44 8.96 29.44 35.2 24.32C877.44 942.592 1024 750.592 1024 524.672c0-282.752-229.248-512-512-512"></path>
</svg>

    </a>


<a href="https://blog.kk17.net/index.xml" rel="noopener alternate" type="application/rss&#43;xml"
    class="iconfont" title="rss" target="_blank">
    <svg class="icon" viewBox="0 0 1024 1024" version="1.1"
  xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink"
  width="30" height="30">
  <path d="M819.157333 1024C819.157333 574.592 449.408 204.8 0 204.8V0c561.706667 0 1024 462.293333 1024 1024h-204.842667zM140.416 743.04a140.8 140.8 0 0 1 140.501333 140.586667A140.928 140.928 0 0 1 140.074667 1024C62.72 1024 0 961.109333 0 883.626667s62.933333-140.544 140.416-140.586667zM678.784 1024h-199.04c0-263.210667-216.533333-479.786667-479.744-479.786667V345.173333c372.352 0 678.784 306.517333 678.784 678.826667z"></path>
</svg>

  </a>
   
</div>

<div class="copyright">
  <span class="power-by">
    Powered by <a class="hexo-link" href="https://gohugo.io">Hugo</a>
  </span>
  <span class="division">|</span>
  <span class="theme-info">
    Theme - <a class="theme-link" href="https://github.com/xianmin/hugo-theme-jane">Jane</a>
  </span>

  <span class="copyright-year">
    &copy;
    
      2015 -
    2019
    <span class="heart">
      
      <i class="iconfont">
        <svg class="icon" viewBox="0 0 1025 1024" version="1.1"
  xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink"
  width="14" height="14">
  <path d="M1000.1 247.9c-15.5-37.3-37.6-70.6-65.7-98.9-54.4-54.8-125.8-85-201-85-85.7 0-166 39-221.4 107.4C456.6 103 376.3 64 290.6 64c-75.1 0-146.5 30.4-201.1 85.6-28.2 28.5-50.4 61.9-65.8 99.3-16 38.8-24 79.9-23.6 122.2 0.7 91.7 40.1 177.2 108.1 234.8 3.1 2.6 6 5.1 8.9 7.8 14.9 13.4 58 52.8 112.6 102.7 93.5 85.5 209.9 191.9 257.5 234.2 7 6.1 15.8 9.5 24.9 9.5 9.2 0 18.1-3.4 24.9-9.5 34.5-30.7 105.8-95.9 181.4-165 74.2-67.8 150.9-138 195.8-178.2 69.5-57.9 109.6-144.4 109.9-237.3 0.1-42.5-8-83.6-24-122.2z"
   fill="#8a8a8a"></path>
</svg>

      </i>
    </span><span class="author">
        Kyle
        
      </span></span>

  
  

  
</div>

    </footer>

    <div class="back-to-top" id="back-to-top">
      <i class="iconfont">
        
        <svg class="icon" viewBox="0 0 1024 1024" version="1.1"
  xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink"
  width="35" height="35">
  <path d="M510.866688 227.694839 95.449397 629.218702l235.761562 0-2.057869 328.796468 362.40389 0L691.55698 628.188232l241.942331-3.089361L510.866688 227.694839zM63.840492 63.962777l894.052392 0 0 131.813095L63.840492 195.775872 63.840492 63.962777 63.840492 63.962777zM63.840492 63.962777"></path>
</svg>

      </i>
    </div>
  </div>
  
<script type="text/javascript" src="/lib/jquery/jquery-3.2.1.min.js"></script>
  <script type="text/javascript" src="/lib/slideout/slideout-1.0.1.min.js"></script>




<script type="text/javascript" src="/js/main.638251f4230630f0335d8c6748e53a96f94b72670920b60c09a56fdc8bece214.js" integrity="sha256-Y4JR9CMGMPAzXYxnSOU6lvlLcmcJILYMCaVv3Ivs4hQ=" crossorigin="anonymous"></script>






  
    <script type="text/javascript" src="/js/load-photoswipe.js"></script>
    <script type="text/javascript" src="/lib/photoswipe/photoswipe.min.js"></script>
    <script type="text/javascript" src="/lib/photoswipe/photoswipe-ui-default.min.js"></script>
  













</body>
</html>
